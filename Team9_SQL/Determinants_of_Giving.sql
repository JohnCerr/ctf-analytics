---Determinants of Giving
--Lead Score

SELECT
LEAD_RATING,
SUM(TOTAL_DONATION_AMOUNT) AS TOTAL_DONATED,
CAST(AVG(TOTAL_DONATION_AMOUNT) AS DECIMAL(20,2)) AS AVERAGE_TOTAL_DONATED,
SUM(NUMBER_OF_TIMES_DONATED) AS NUMBER_OF_DONATIONS,
CAST(AVG(NUMBER_OF_TIMES_DONATED) AS INT) AS AVERAGE_NUMBER_OF_DONATIONS
FROM (
SELECT
A.NAME,
A.ID,
MAX(HIGHEST_LEAD_RATING_FORMULA__C) AS LEAD_RATING,
MAX(NPO02__AVERAGEAMOUNT__C) AS AVERAGE_DONATION_AMOUNT,
MAX(NPE01__LIFETIMEDONATIONHISTORY_NUMBER__C) AS NUMBER_OF_TIMES_DONATED,
MAX(NPE01__LIFETIMEDONATIONHISTORY_AMOUNT__C) AS TOTAL_DONATION_AMOUNT,
MAX(EXPECTEDREVENUE) AS EXPECTED_REVENUE
FROM "PROD_CTF_CLEAN"."CTF_CLEAN_T9"."ACCOUNT" A
INNER JOIN "PROD_CTF_CLEAN"."CTF_CLEAN_T9"."OPPORTUNITY" O
ON A.ID = O.ACCOUNTID
WHERE ISCLOSED = 'TRUE' AND ISWON = 'TRUE' AND STAGENAME = 'Received'
GROUP BY A.ID, A.NAME
) A
GROUP BY LEAD_RATING
ORDER BY LEAD_RATING DESC